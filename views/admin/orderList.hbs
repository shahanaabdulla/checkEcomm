<!-- admin/orderList.handlebars -->
<style>
    .status-select {
      margin-right: 5px;
    }
    
    .update-btn {
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <section>
    <div class="container">
      <div class="row  m-5 text-center">
        <h1>Order Details</h1>
      </div>

      <table class="table mt-5" id="ordersTable">
        <thead>
          <tr>
            <th scope="col">Order ID</th>
          
            <th scope="col">Products</th>

           
            <th scope="col">Total Price</th>
            <th scope="col">Shipping Address</th>
            <th scope="col">Payment Method</th>
            <th scope="col">Status</th>
            <th scope="col">Created At</th>
            <th scope="col">Update Status</th>
          </tr>
        </thead>
        <tbody>
          {{#each orders}}
          <tr>
            <td>{{this.orderID}}</td>
           
     <td>
              <ul>
                {{#each this.items}}
                  <li>{{this.product.name}} (Quantity: {{this.quantity}})</li>
                {{/each}}
              </ul>
            </td>
             
            <td>{{this.totalPrice}}</td>
            <td>{{this.shippingAddress}}</td>
            <td>{{this.paymentMethod}}</td>
            <td class="status">{{this.status}}</td>
           <td>{{formatDate this.createdAt}}</td>
            <td>
              <select class="form-select status-select" data-order-id="{{this._id}}">
                <option value="Confirmed">Confirmed</option>
                <option value="Out for Delivery">Out for Delivery</option>
                <option value="Delivered">Delivered</option>
              </select>
              <button class="btn btn-primary update-btn">Update</button>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </section>
  {{!-- <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/css/jquery.dataTables.css">
   <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/css/jquery.dataTables_themeroller.css">
   <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js"></script>
   <script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/jquery.dataTables.min.js"></script> --}}

<script type="text/javascript">

$(document).ready(function(){
    $('#ordersTable').DataTable();
});

</script>
  
  
  
 
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const updateButtons = document.querySelectorAll('.update-btn');

      updateButtons.forEach(button => {
        button.addEventListener('click', function() {
          const orderId = this.parentNode.querySelector('.status-select').dataset.orderId;
          const newStatus = this.parentNode.querySelector('.status-select').value;
          console.log(orderId)
          console.log(newStatus)
          fetch('/order/update-order-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderId, newStatus })
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Failed to update status.');
            }
          })
          .then(data => {
            let statusCell = this.parentNode.parentNode.querySelector('.status');
            if (statusCell) {
              statusCell.textContent = newStatus;
            } else {
              throw new Error('Failed to find status cell.');
            }
          })
          .catch(error => {
            console.error(error);
            alert('Failed to update status. Please try again.');
          });
        });
      });
    });
  </script>