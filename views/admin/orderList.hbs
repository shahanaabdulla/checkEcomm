<!-- admin/orderList.handlebars -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
  <style>
    .status-select {
      margin-right: 5px;
    }

    .update-btn {
      margin-left: 5px;
    }

   

    .status-filter {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <section>
    <div class="container">
      <div class="row m-5 text-center">
        <h1>Order Details</h1>
      </div>
      <div class="row">
        <div class="col-md-12">
          <select id="statusFilter" class="form-select status-filter">
            <option value="">All</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Out for Delivery">Out for Delivery</option>
            <option value="Delivered">Delivered</option>
            <option value="Returned">Returned</option>
            <option value="Return request placed">Return request placed</option>
            <option value="Approved">Return Approved</option>
            <option value="Rejected">Return Rejected</option>
          </select>
        </div>
      </div>
      <table class="table mt-5" id="ordersTable">
        <thead>
          <tr>
            <th scope="col">Order ID</th>
            <th scope="col">Products</th>
            <th scope="col">Total Price</th>
            <th scope="col">Shipping Address</th>
            <th scope="col">Payment Method</th>
            <th scope="col">Status</th>
            <th scope="col">Reason for Return</th>
            <th scope="col">Created At</th>
            <th scope="col">Update Status</th>
          </tr>
        </thead>
        <tbody>
          {{#each orders}}
        
            <td>{{this.orderID}}</td>
            <td>
              <ul>
                {{#each this.items}}
                  <li>{{this.product.name}} (Quantity: {{this.quantity}})</li>
                {{/each}}
              </ul>
            </td>
         <td>{{this.totalPrice}}</td>
<td>{{this.shippingAddress}}</td>
<td>{{this.paymentMethod}}</td>
<td>
  {{#if (eq this.status 'Return request placed')}}
    <span style="color: red; font-weight: bold;">{{this.status}}</span>
  {{else}}
    {{this.status}}
  {{/if}}
</td>

<td>{{this.returnReason}}</td>
<td>{{formatDate this.createdAt}}</td>
<td>
              <select class="form-select status-select" data-order-id="{{this._id}}">
                {{#if (eq this.status 'Return request placed')}}
                  <option value="Confirmed">Confirmed</option>
                  <option value="Out for Delivery">Out for Delivery</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Returned">Returned</option>
                  <option value="Approved">Return Approved</option>
                  <option value="Rejected">Return Rejected</option>
                {{else}}
                  <option value="Confirmed">Confirmed</option>
                  <option value="Out for Delivery">Out for Delivery</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Returned">Returned</option>
                {{/if}}
              </select>
              <button class="btn btn-primary update-btn">Update</button>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function() {
      var table = $('#ordersTable').DataTable({
        columnDefs: [
          { targets: [7], type: 'date', orderData: [7] }, // Assuming createdAt is the 8th column (index 7)
          { targets: [5], searchable: true } // Ensure the status column is searchable
        ],
        order: [[7, 'desc']] // Sort by the 8th column (createdAt) in descending order
      });

      function attachUpdateListeners() {
        $('.update-btn').off('click').on('click', function() {
          const orderId = $(this).siblings('.status-select').data('order-id');
          const newStatus = $(this).siblings('.status-select').val();
          console.log(orderId);
          console.log(newStatus);
          fetch('/order/update-order-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderId, newStatus })
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Failed to update status.');
            }
          })
          .then(data => {
            let statusCell = $(this).closest('tr').find('.status');
            if (statusCell) {
              statusCell.text(newStatus);
              statusCell.removeClass('status-red');
              if (newStatus === 'Returned' || newStatus === 'Return request placed') {
                statusCell.addClass('status-red');
              }
              // Remove the highlight class if the status is changed
              if (newStatus !== 'Return request placed') {
                $(this).closest('tr').removeClass('status-highlight');
              }
            } else {
              throw new Error('Failed to find status cell.');
            }
          })
          .catch(error => {
            console.error(error);
            alert('Failed to update status. Please try again.');
          });
        });
      }

      attachUpdateListeners();

      $('#statusFilter').on('change', function() {
        var selectedStatus = $(this).val();
        if (selectedStatus) {
          table.column(5).search('^' + selectedStatus + '$', true, false).draw();
        } else {
          table.column(5).search('').draw();
        }
      });
    });
  </script>
</body>
</html>
